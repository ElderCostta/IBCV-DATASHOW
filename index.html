<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IBCV - DATASHOW</title>
  <link rel="manifest" href="manifest.json">
  <style>
    /* ... (mant√©m os estilos que j√° estavam no seu c√≥digo) ... */
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <img src="LogoIBCV.jpg" alt="Logo IBCV">
    </div>

    <h1>IBCV-DATASHOW</h1>

    <div class="config">
      <label>
        <span class="status-indicator" id="statusIndicator"></span>
        IP do Projetor:
        <input id="ip" type="text" placeholder="192.168.0.150" />
      </label>
      <label>
        Senha PJLink (opcional):
        <input id="senha" type="password" placeholder="Deixe em branco se n√£o tiver" />
      </label>
      <label>
        <input id="demo" type="checkbox" />
        Modo Demo (simular comandos)
      </label>
      <button id="conectar">Conectar ao Projetor</button>
    </div>

    <!-- ... seus bot√µes e controles continuam iguais ... -->

    <div>
      <h3>üìã Log de Atividades:</h3>
      <pre id="log">Aguardando conex√£o...</pre>
      <button onclick="limparLog()">üóëÔ∏è Limpar Log</button>
    </div>
  </div>

  <script>
    let ipProjetor = "";
    let senhaPJLink = "";
    let modoDemo = false;
    let conectado = false;

    const ipBridge = "localhost";
    const portaBridge = 3000;

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('SW registered'))
        .catch(error => console.log('SW registration failed', error));
    }

    document.getElementById("conectar").addEventListener("click", () => {
      ipProjetor = document.getElementById("ip").value.trim();
      senhaPJLink = document.getElementById("senha").value.trim(); // Agora opcional
      modoDemo = document.getElementById("demo").checked;

      if (!ipProjetor && !modoDemo) {
        alert("‚ö†Ô∏è Digite o IP do projetor ou ative o modo DEMO!");
        return;
      }

      conectado = true;
      atualizarStatusIndicador();
      
      const timestamp = new Date().toLocaleTimeString();
      logMsg(`[${timestamp}] ‚úÖ Conectado ao projetor ${ipProjetor || "DEMO"}`);
      logMsg(`[${timestamp}] üîß Modo Demo: ${modoDemo ? 'ATIVADO' : 'DESATIVADO'}`);
      
      if (!modoDemo) {
        testarConexao();
      }
    });

    function testarConexao() {
      logMsg(`[${new Date().toLocaleTimeString()}] üîç Testando conex√£o...`);
      enviarComando('%1POWR ?');
    }

    function enviarComando(comando) {
      if (!ipProjetor && !modoDemo) {
        alert("‚ö†Ô∏è Digite o IP do projetor ou ative o modo DEMO!");
        return;
      }

      const timestamp = new Date().toLocaleTimeString();
      logMsg(`[${timestamp}] üì§ Enviando: ${comando}`);

      if (modoDemo) {
        setTimeout(() => {
          let resposta = "OK";
          if (comando.includes('POWR ?')) resposta = "1"; 
          else if (comando.includes('POWR 1')) resposta = "Ligando...";
          else if (comando.includes('POWR 0')) resposta = "Desligando...";
          logMsg(`[${new Date().toLocaleTimeString()}] üì• [DEMO] Resposta: ${resposta}`);
        }, 600);
        return;
      }

      // Se senha n√£o for digitada, envia s√≥ com IP e comando
      const bodyReq = { ip: ipProjetor, comando };
      if (senhaPJLink) bodyReq.senha = senhaPJLink;

      fetch(`http://${ipBridge}:${portaBridge}/comando`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(bodyReq)
      })
        .then(res => res.text())
        .then(txt => {
          logMsg(`[${new Date().toLocaleTimeString()}] üì• Resposta: ${txt}`);
          if (txt.includes("erro") || txt.includes("falhou")) {
            conectado = false;
            atualizarStatusIndicador();
          }
        })
        .catch(err => {
          logMsg(`[${new Date().toLocaleTimeString()}] ‚ùå Erro: ${err.message}`);
          conectado = false;
          atualizarStatusIndicador();
        });
    }

    function logMsg(msg) {
      const logElement = document.getElementById("log");
      logElement.textContent += msg + "\n";
      logElement.scrollTop = logElement.scrollHeight;
    }

    function limparLog() {
      document.getElementById("log").textContent = "Log limpo...\n";
    }

    function atualizarStatusIndicador() {
      const indicator = document.getElementById("statusIndicator");
      if (conectado) {
        indicator.classList.add("connected");
      } else {
        indicator.classList.remove("connected");
      }
    }

    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey) {
        if (e.key === '1') enviarComando('%1POWR 1');
        if (e.key === '0') enviarComando('%1POWR 0');
      }
    });
  </script>
</body>
</html>
